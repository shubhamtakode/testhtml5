<!DOCTYPE html>
<html>
<head>
  <title>Timer with Persistent Storage</title>
  <meta charset="utf-8">
  <style type="text/css">
    P#time {
      font-size: 48pt;
      font-family: courier;
      margin: 0px auto;
      color: gray;
    }
  </style>
  <script type="text/javascript">
    timer = null;

    function get_time() {
      var now = new Date;
      return now.getTime();
    }

    function show() {
      var t = timer ? get_time() - base : total;
      var s = Math.round(t/1000);
      var m = Math.floor(s/60);
      var h = Math.floor(m/60);
      s = s%60;
      if (s < 10) s = "0"+s;
      m = m%60;
      if (m < 10) m = "0"+m;
      if (h < 10) h = "0"+h;
      p.innerHTML = h+":"+m+":"+s;
    }

    function update() {
      show();
      dt = 1000 - (get_time()-base)%1000;
      timer = setTimeout(update, dt);
    }

    function start() {
      base = get_time() - total;
      localStorage.base = base;
      delete localStorage.total;
      p.style.color = "black";
      update();
    }

    function stop() {
      clearTimeout(timer);
      timer = null;
      total = get_time() - base;
      delete localStorage.base;
      localStorage.total = total;
      p.style.color = "gray";
    }

    function key_handler(e) {
      if (e.keyCode != 32) return true;
      if (timer) stop(); else start();
    }

    function init() {
      p = document.getElementById("time");
      total = localStorage.total ? localStorage.total : 0.0;
      show();
      if (localStorage.base) {
        total = get_time() - localStorage.base;
        start();
      }
      window.onkeydown = key_handler;
    }
  </script>
</head>
<body onload="init()">
  <p id="time">loading &hellip;
  <p>Use the SPACE key to start/stop the timer.<br>
  It will magically keep working, even while you are logged out.
</body>
</html>
